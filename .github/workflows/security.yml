name: Security Scanning

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  dependency-scan:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo-audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: ${{ runner.os }}-cargo-audit-bin

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked || true

      - name: Run cargo audit
        run: cargo audit --deny warnings

      - name: Check for outdated dependencies
        run: |
          cargo install cargo-outdated --locked || true
          cargo outdated --root-deps-only --exit-code 1 || echo "Some dependencies are outdated"

  sast-scan:
    name: SAST Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-sast-${{ hashFiles('**/Cargo.lock') }}

      - name: Run clippy with strict flags
        run: |
          cargo clippy --all-targets --all-features -- \
            -D warnings \
            -D clippy::all \
            -D clippy::pedantic \
            -D clippy::cargo \
            -A clippy::multiple_crate_versions \
            -A clippy::module_name_repetitions

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo-deny
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-deny
          key: ${{ runner.os }}-cargo-deny-bin

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked || true

      - name: Check licenses
        run: cargo deny check licenses

      - name: Check advisories
        run: cargo deny check advisories

      - name: Check bans
        run: cargo deny check bans

  supply-chain-scan:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo-vet
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-vet
          key: ${{ runner.os }}-cargo-vet-bin

      - name: Install cargo-vet
        run: cargo install cargo-vet --locked || true

      - name: Run cargo-vet (informational)
        run: cargo vet --locked || echo "cargo-vet found issues (informational only)"
        continue-on-error: true

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'javascript'
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        run: npm audit --audit-level=moderate

  safety-check:
    name: Unsafe Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Cache cargo-geiger
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-geiger
          key: ${{ runner.os }}-cargo-geiger-bin

      - name: Install cargo-geiger
        run: cargo install cargo-geiger --locked || true

      - name: Run cargo-geiger
        run: cargo geiger --all-features || echo "Unsafe code detected (informational)"
        continue-on-error: true

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-scan, secret-scan, license-compliance, npm-audit]
    if: always()
    steps:
      - name: Check all security jobs
        run: |
          if [ "${{ needs.dependency-scan.result }}" != "success" ] || \
             [ "${{ needs.sast-scan.result }}" != "success" ] || \
             [ "${{ needs.secret-scan.result }}" != "success" ] || \
             [ "${{ needs.license-compliance.result }}" != "success" ] || \
             [ "${{ needs.npm-audit.result }}" != "success" ]; then
            echo "One or more security checks failed"
            exit 1
          fi
          echo "All security checks passed!"
