name: Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-rust-docs:
    name: Build Rust Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-

      - name: Build documentation
        run: |
          cargo doc --workspace --no-deps --all-features --document-private-items
        env:
          RUSTDOCFLAGS: "--enable-index-page -Zunstable-options"

      - name: Add redirect page
        run: |
          echo '<meta http-equiv="refresh" content="0; url=api/index.html">' > target/doc/index.html

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-docs
          path: target/doc/
          retention-days: 7

  build-mdbook:
    name: Build mdBook Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install mdBook
        run: |
          mkdir -p ~/mdbook
          curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.4.36/mdbook-v0.4.36-x86_64-unknown-linux-gnu.tar.gz | tar -xz --directory=~/mdbook
          echo "$HOME/mdbook" >> $GITHUB_PATH

      - name: Create book structure (if not exists)
        run: |
          if [ ! -f "book.toml" ]; then
            mkdir -p book/src
            cat > book.toml <<EOF
          [book]
          title = "Intent Segregation Documentation"
          authors = ["Intent Segregation Team"]
          language = "en"
          multilingual = false
          src = "book/src"

          [output.html]
          theme = "docs/theme"
          default-theme = "light"
          preferred-dark-theme = "navy"
          git-repository-url = "https://github.com/${{ github.repository }}"

          [output.html.search]
          enable = true
          EOF

            cat > book/src/SUMMARY.md <<EOF
          # Summary

          [Introduction](./introduction.md)

          # User Guide
          - [Getting Started](./user-guide/getting-started.md)
          - [Configuration](./user-guide/configuration.md)
          - [API Reference](./user-guide/api-reference.md)

          # Architecture
          - [System Overview](./architecture/overview.md)
          - [Security Model](./architecture/security.md)
          - [Components](./architecture/components.md)

          # Developer Guide
          - [Contributing](./developer-guide/contributing.md)
          - [Testing](./developer-guide/testing.md)
          - [Deployment](./developer-guide/deployment.md)
          EOF

            cat > book/src/introduction.md <<EOF
          # Intent Segregation

          Welcome to the Intent Segregation documentation.

          This project implements an intent-first, schema-driven security architecture
          designed to mitigate prompt injection and unsafe LLM actions.

          Please refer to the [README](https://github.com/${{ github.repository }})
          for project overview and quick start guide.
          EOF

            mkdir -p book/src/user-guide
            mkdir -p book/src/architecture
            mkdir -p book/src/developer-guide

            # Create placeholder files
            for file in book/src/user-guide/*.md book/src/architecture/*.md book/src/developer-guide/*.md; do
              if [ ! -f "$file" ]; then
                echo "# $(basename $file .md)" > "$file"
                echo "" >> "$file"
                echo "Content coming soon..." >> "$file"
              fi
            done
          fi

      - name: Build mdBook
        run: |
          if [ -f "book.toml" ]; then
            ~/mdbook/mdbook build
          else
            echo "No book.toml found, skipping mdBook build"
            mkdir -p book/html
            echo "<h1>Documentation placeholder</h1>" > book/html/index.html
          fi

      - name: Upload mdBook artifact
        uses: actions/upload-artifact@v4
        with:
          name: mdbook-docs
          path: book/html/
          retention-days: 7

  combine-and-deploy:
    name: Combine and Deploy Documentation
    runs-on: ubuntu-latest
    needs: [build-rust-docs, build-mdbook]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Download Rust docs
        uses: actions/download-artifact@v4
        with:
          name: rust-docs
          path: ./public/api

      - name: Download mdBook docs
        uses: actions/download-artifact@v4
        with:
          name: mdbook-docs
          path: ./public

      - name: Create index page
        run: |
          cat > ./public/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Intent Segregation Documentation</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 900px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.6;
                  }
                  h1 { color: #2c3e50; }
                  .card {
                      border: 1px solid #ddd;
                      border-radius: 8px;
                      padding: 20px;
                      margin: 20px 0;
                      background: #f9f9f9;
                  }
                  .card h2 { margin-top: 0; }
                  a {
                      color: #3498db;
                      text-decoration: none;
                  }
                  a:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
              <h1>Intent Segregation Documentation</h1>
              <p>Welcome to the Intent Segregation project documentation.</p>

              <div class="card">
                  <h2>üìö User Guide</h2>
                  <p>Learn how to use the Intent Segregation system.</p>
                  <a href="./user-guide/getting-started.html">Get Started ‚Üí</a>
              </div>

              <div class="card">
                  <h2>üîß API Documentation</h2>
                  <p>Browse the complete Rust API documentation.</p>
                  <a href="./api/index.html">API Docs ‚Üí</a>
              </div>

              <div class="card">
                  <h2>üèóÔ∏è Architecture</h2>
                  <p>Understand the system architecture and design decisions.</p>
                  <a href="./architecture/overview.html">Architecture ‚Üí</a>
              </div>

              <div class="card">
                  <h2>üë®‚Äçüíª Developer Guide</h2>
                  <p>Contributing guidelines and development setup.</p>
                  <a href="./developer-guide/contributing.html">Developer Guide ‚Üí</a>
              </div>
          </body>
          </html>
          EOF

      - name: Upload combined artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  check-docs:
    name: Check Documentation Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Check for documentation warnings
        run: |
          cargo doc --workspace --no-deps --all-features 2>&1 | tee doc_warnings.txt
          if grep -q "warning" doc_warnings.txt; then
            echo "Documentation warnings found:"
            cat doc_warnings.txt
            exit 1
          fi
        continue-on-error: true

      - name: Check for missing documentation
        run: |
          cargo rustdoc --all-features -- -D missing-docs || echo "Some items are missing documentation"
        continue-on-error: true

  link-checker:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    needs: [build-rust-docs, build-mdbook]
    steps:
      - name: Download Rust docs
        uses: actions/download-artifact@v4
        with:
          name: rust-docs
          path: ./docs

      - name: Download mdBook docs
        uses: actions/download-artifact@v4
        with:
          name: mdbook-docs
          path: ./docs

      - name: Check links
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress './docs/**/*.html'
          fail: true
        continue-on-error: true
